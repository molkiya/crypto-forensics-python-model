# Bitcoin AML Detection using Graph Neural Networks

Проект для обнаружения отмывания денег (AML) в транзакциях Bitcoin с использованием графовых нейронных сетей (GNN).

## Описание

Этот проект использует графовые нейронные сети для анализа транзакций Bitcoin и выявления подозрительной активности. Модель основана на архитектуре Chebyshev Convolution (ChebConv) и обучена на датасете Elliptic.

## Структура проекта

```
diploma/
├── src/                    # Исходный код (основная библиотека)
│   ├── api/                # REST API сервис для интеграции с Rust
│   │   ├── models.py      # Pydantic модели для валидации
│   │   ├── data_adapter.py # Преобразование JSON → граф
│   │   ├── response_adapter.py # Преобразование модель → JSON
│   │   ├── service.py      # FastAPI приложение
│   │   └── run_server.py  # Скрипт запуска сервера
│   ├── models/            # Модели нейронных сетей (публичные)
│   │   └── custom_gat/    # Кастомные GAT модели
│   ├── utils.py           # Вспомогательные функции
│   └── utils/             # Дополнительные утилиты
├── training/              # Код для обучения модели (конфиденциально)
│   ├── main.py            # Главный скрипт обучения
│   ├── train.py           # Функции обучения и тестирования
│   └── loader.py          # Загрузка и подготовка данных для обучения
├── data/                  # Данные (не включены в репозиторий)
│   └── elliptic/          # Elliptic датасет
├── models/                # Обученные модели (конфиденциально, не в репозитории)
├── output/                # Результаты обучения и метрики
├── config.yaml           # Конфигурация модели
├── requirements.txt      # Зависимости Python
└── README.md            # Этот файл

```

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd diploma
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Использование

1. Подготовьте данные:
   - Разместите датасет Elliptic в директории `data/elliptic/dataset/elliptic_plus/`
   - Или используйте скрипт `src/download_data.py` для загрузки данных

2. Настройте конфигурацию:
   - Отредактируйте `config.yaml` для изменения гиперпараметров модели

3. Запустите обучение:
```bash
cd training
python main.py
```

**Примечание:** Код обучения находится в директории `training/` и не включен в публичный репозиторий для сохранения конфиденциальности.

## Конфигурация

Основные параметры в `config.yaml`:

- `data_path`: путь к данным
- `use_cuda`: использование GPU (True/False)
- `hidden_units`: количество скрытых нейронов
- `hidden_units_noAgg`: количество нейронов без агрегации
- `epochs`: количество эпох обучения
- `num_classes`: количество классов
- `lr`: learning rate
- `weight_decay`: коэффициент регуляризации

## Модель

### Архитектура

Проект использует модель `ChebyshevConvolution` на основе ChebConv слоев из PyTorch Geometric. 

**Примечание:** Код модели находится в директории `training/models.py` и не включен в публичный репозиторий для сохранения конфиденциальности.

Архитектура включает:
- Три сверточных слоя с ядрами размеров [1, 2, 4]
- Функции активации ReLU6
- Классификация на 2 класса (легальные/нелегальные транзакции)

### Входные данные

Модель ожидает графовую структуру данных в формате PyTorch Geometric `Data`:

**Вход:**
- `x` (torch.Tensor): Матрица признаков узлов размером `[num_nodes, num_features]`
  - `num_nodes`: количество узлов (транзакций) в графе
  - `num_features`: количество признаков для каждого узла (зависит от конфигурации, обычно 94-166 признаков)
  - Тип: `torch.float32`
  
- `edge_index` (torch.Tensor): Матрица индексов рёбер размером `[2, num_edges]`
  - Первая строка: индексы исходных узлов
  - Вторая строка: индексы целевых узлов
  - Тип: `torch.long`
  
- `y` (torch.Tensor): Метки классов размером `[num_nodes]`
  - Значения: 0 (легальная транзакция) или 1 (нелегальная транзакция)
  - Тип: `torch.long`

**Формат данных:**
- Данные должны быть представлены как объект `torch_geometric.data.Data`
- Граф должен быть неориентированным (рёбра представлены в обоих направлениях)
- Признаки узлов должны быть нормализованы/масштабированы

### Выходные данные

**Выход:**
- `out` (torch.Tensor): Логиты классификации размером `[num_nodes, num_classes]`
  - `num_classes`: количество классов (2 для бинарной классификации)
  - Тип: `torch.float32`
  - Для получения предсказаний: `pred = out.argmax(dim=1)` (возвращает индексы классов 0 или 1)
  
- `edge_index` (torch.Tensor): Структура графа, переданная без изменений

**Использование:**
```python
out, edge_index = model((data.x, data.edge_index))
predictions = out.argmax(dim=1)  # Получить предсказанные классы
probabilities = torch.softmax(out, dim=1)  # Получить вероятности классов
```

### Параметры модели

- `hidden_units`: количество нейронов в скрытых слоях (по умолчанию: 128)
- `kernel`: размеры ядер свертки для каждого слоя `[1, 2, 4]`
- `num_classes`: количество выходных классов (2 для бинарной классификации)

## Метрики

Модель оценивается по следующим метрикам:
- Precision
- Recall
- F1 Score
- F1 Micro Average

Результаты сохраняются в `output/metrics_robust_base_tx_wallet.csv` и визуализируются в виде графиков.

## Лицензия

Этот проект лицензирован под Apache License 2.0. См. файл [LICENSE](LICENSE) для подробностей.

## Зависимости

Основные зависимости:
- PyTorch
- PyTorch Geometric
- NumPy
- Pandas
- Scikit-learn
- Matplotlib
- NetworkX

Полный список зависимостей см. в `requirements.txt`.

## API Сервис

Проект включает REST API сервис для интеграции с Rust приложением.

### Запуск API сервиса

```bash
cd src
python -m api.run_server
```

Сервис будет доступен по адресу: `http://localhost:8000`

### Endpoints

- `POST /api/v1/analyze` - Анализ одной транзакции
- `POST /api/v1/batch_analyze` - Пакетная обработка транзакций
- `GET /health` - Health check

### Формат данных

API принимает JSON запросы от Rust приложения в формате, описанном в `src/api/README.md`.

**Важно:** Модель не изменяется. Все преобразования данных выполняются через адаптеры:
- `data_adapter.py` - преобразует JSON запрос в графовую структуру
- `response_adapter.py` - преобразует выход модели в JSON ответ

Подробнее см. документацию в `src/api/README.md`.

## Авторы

[Ваше имя/организация]

## Благодарности

- Elliptic за предоставление датасета
- PyTorch Geometric за библиотеку для работы с графовыми нейронными сетями

